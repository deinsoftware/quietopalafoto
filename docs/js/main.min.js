$(document).ready(function() {
  setTimeout(() => {
    loadRestrictions();
    loadTwitter();
    loadFacebook();
  }, 3000);
});

var loadHeight = function() {};

var loadTwitter = function() {
  var difference =
    $('#twitter-widget-0').height() +
    ($('#maps').height() - $('#twitter-widget-0').height()) -
    5;
  $('#tweets').height($('#maps').height());
  $('#twitter-widget-0').css({ height: difference + 'px' });
};

var fbURL = 'https://www.facebook.com/';
var fbPage = 'quietopalafoto';
var fbAPI = 'https://graph.facebook.com/' + 'v2.10/';
var fbToken = '&access_token=763465203723077|2a943f653712fcce25de89d9247e2654';

var loadFacebook = function() {
  var urlPage = fbURL + fbPage;
  $('[id^=fan]').attr('href', urlPage);

  var urlFan = fbPage + '/?fields=fan_count';
  $.getJSON(fbAPI + urlFan + fbToken + '&callback=?', function(json) {
    if (json.fan_count) {
      $('#news span.badge').text(json.fan_count);
    } else {
      $('#fbk-fan').hide();
    }
  });

  var urlPost = fbPage + '/feed/?limit=12';
  $.getJSON(fbAPI + urlPost + fbToken + '&callback=?', function(json) {
    var html = '';
    $.each(json.data, function(i, fb) {
      html += '<div class="col-sm-6 col-md-4">';
      html += '    <div id="' + fb.id + '" class="well well-sm">';
      /* attach will be here */
      html += '    </div>';
      html += '</div>';

      var urlDetail =
        fb.id +
        '/?fields=attachments,likes.summary(true),shares,comments.summary(true)';
      $.getJSON(fbAPI + urlDetail + fbToken + '&callback=?', function(json) {
        var attach = '';
        attach += '<a href="' + fbURL + fb.id + '">';
        if (json.attachments.data[0].type === 'album') {
          attach +=
            '    <div class="image-full" style="background-image: url(\'' +
            json.attachments.data[0].subattachments.data[0].media.image.src +
            '\');">';
        } else {
          attach +=
            '    <div class="image-full" style="background-image: url(\'' +
            json.attachments.data[0].media.image.src +
            '\');">';
        }
        attach += '    </div>';
        attach += '    <div class="item-content">';
        attach += '        <div class="item-text">';
        attach +=
          '            ' +
          (fb.message
            ? fb.message
            : json.attachments.data[0].title
            ? json.attachments.data[0].title.cleanSource()
            : '') +
          '';
        attach += '        </div>';
        attach += '    </div>';
        attach += '</a>';
        $(attach).appendTo('#' + fb.id);
      });

      if ((i + 1) % 2 === 0) {
        html += '<div class="clearfix visible-sm-block"></div>';
      }
      if ((i + 1) % 3 === 0) {
        html +=
          '<div class="clearfix visible-md-block visible-lg-block"></div>';
      }
    });

    $(html).appendTo('#feed');
  });
};

String.prototype.cleanSource = function() {
  var titleValue = this;
  var jsonFilter = [
    ' - El Colombiano.com',
    ' • ENTER.CO',
    '-H13 Noticias',
    ' - La FM',
    ' | Minuto30.com',
    ' - NeoTeo',
    '[Noticias]',
    ' - Teleantioquia',
    ' - Telemedellín',
    ' - tuexperto.com',
    'Reportaje:',
    'VIDEO:',
    'Vídeo. ',
    ' |',
  ];
  $.each(jsonFilter, function(i, filter) {
    titleValue = titleValue.replace(filter, '');
  });
  return titleValue;
};

function convertISOtoDate(value, format) {
  if (!value) {
    return '';
  }

  var date = new Date(value);
  var result = '';
  switch (format) {
    case 'short':
      result =
        date.getDate() +
        ' ' +
        getMonthName(date.getMonth(), shortMonthsName);
      break;
    case 'long':
      result =
        date.getDate() +
        ' ' +
        getMonthName(date.getMonth(), longMonthsName);
      break;

    default:
      result = date.toISOString().substr(0, 10);
      break;
  }
  return result;
}

var shortMonthsName = [
  'Ene',
  'Feb',
  'Mar',
  'Abr',
  'May',
  'Jun',
  'Jul',
  'Ago',
  'Sep',
  'Oct',
  'Nov',
  'Dic',
];

var longMonthsName = [
  'Enero',
  'Febrero',
  'Marzo',
  'Abril',
  'Mayo',
  'Junio',
  'Julio',
  'Agosto',
  'Septiembre',
  'Octubre',
  'Noviembre',
  'Diciembre',
];

function getMonthName(month, nameList) {
  if (!month) {
    return '';
  }

  return nameList[month];
}

function convertISOtoYear(value) {
  if (!value) {
    return '';
  }

  var date = new Date(value);
  return date.getFullYear();
}

function convertMilitarToStandardTime(military) {
  if (!military) {
    return '';
  }

  var hour = military.substring(2, 0);
  var mins = military.substring(2);
  return (hour > 12 ? hour - 12 : hour * 1) + ':' + mins;
}

function getMeridian(military) {
  if (!military) {
    return '';
  }

  var hour = military.substring(2, 0);
  return hour < 12 ? 'AM' : 'PM';
}

function getTimeRange(time) {
  if (!time) {
    return '';
  }

  var range =
    convertMilitarToStandardTime(time.start) +
    (time.start && time.end ? '-' : '') +
    convertMilitarToStandardTime(time.end) +
    ' ' +
    getMeridian(time.end || time.start);
  return range;
}

function getWeekDay(day) {
  var date = new Date();
  var weekDay = new Date(date.setDate(date.getDate() - date.getDay() + day));
  return weekDay;
}

function isDateOnRange(range) {
  var dateStart = new Date(range.date.start);
  var dateEnd = new Date(range.date.end);
  return (
    dateStart < Date.now() &&
    (!range.date.end || Date.now() <= dateEnd.setDate(dateEnd.getDate() + 1))
  );
}

var restrictions = {};

var filterData = function(data) {
  data = data.pyp.schedule;
  data = data.filter(isDateOnRange);
  return data;
};

var currentData = function(data) {
  data.forEach((element) => {
    $.extend(true, restrictions, element);
  });
};

$.ajax({
  url: '../data/restrictions.json',
  dataType: 'json',
  cache: false,
  success: function(data, status) {
    data = filterData(data);
    currentData(data);
  },
  error: function(xhr, textStatus, err) {
    console.log(
      'readyState: ' + xhr.readyState + '\n xhrStatus: ' + xhr.status,
    );
    console.log('responseText: ' + xhr.responseText);
  },
});

var level = '';
var hash = '';
var free = '';

var types = ['vehicle', 'bike'];
var weekDays = ['mo', 'tu', 'we', 'th', 'fr'];

function weekRestriction(type, day) {
  var numbers = restrictions.type[type].day[day];
  $('#' + type + '-' + day).text(numbers.join('-'));
}

function setLevel() {
  $('#level').removeClass('hidden-lg');
  $('#level-number').text(restrictions.level);
  $('#level-restrictions').text(free);
  $('#level')
    .removeClass('panel-info')
    .addClass('panel-' + level);
  $('#level .alert-info')
    .removeClass('alert-info')
    .addClass('alert-' + level);
  $('#restrictions')
    .removeClass('panel-info')
    .addClass('panel-' + level);
  $('#restrictions .alert-info')
    .removeClass('alert-info')
    .addClass('alert-' + level);
  $('#restrictions .text-info')
    .removeClass('text-info')
    .addClass('text-' + level);
  $('#restrictions-title strong').removeClass(
    'hidden-xs hidden-sm hidden-md hidden-lg',
  );
  $('#restrictions-hash').text(hash);
  if (restrictions.level === 3) {
    $('#restrictions-free').text('#' + free.replace(/\s/g, '') + 'ViasExentas');
    $('#restrictions-free').removeClass('hidden-xs');
  }
}

function setBike() {
  var bike = [];
  restrictions.type.bike.class['2T'].apply && bike.push('2T');
  restrictions.type.bike.class['4T'].apply && bike.push('4T');
  $('#bike-title span').text(bike.join('/'));
}

function setDates() {
  var start = convertISOtoDate(restrictions.date.start, 'long');
  var end = convertISOtoDate(restrictions.date.end, 'long');
  $('#schedule-models strong span')
    .eq(0)
    .text('Desde ' + start);
  $('#schedule-models strong span')
    .eq(1)
    .text(end && ' a ' + end);
  var day = restrictions.type.day;
  if (day && day.weekdays) {
    $('#weekend').removeClass('hidden-xs hidden-sm hidden-md hidden-lg');
    let weekendTitle =
      {
        sa: 'Sábado',
        do: 'Domingo',
      }[day.weekdays] || 'Sábado y Domingo';
    $('#weekend > h4').text(weekendTitle);
    var even = day.date.even.map((date) =>
      convertISOtoDate(date + 'T00:00:00.000-05:00', 'short'),
    );
    $('#all-sa-even').text(even.join(', '));
    var odd = day.date.odd.map((date) =>
      convertISOtoDate(date + 'T00:00:00.000-05:00', 'short'),
    );
    $('#all-sa-odd').text(odd.join(', '));
  }
}

function setHours() {
  $('#schedule-models').removeClass('hidden-xs hidden-sm hidden-md hidden-lg');
  var models = restrictions.type.model;
  for (var key in models) {
    if (models.hasOwnProperty(key)) {
      var morning = models[key][0];
      var night = models[key][1];
      var range = '';
      range += getTimeRange(morning);
      range += ' | ';
      range += getTimeRange(night);
      if ((key | 0) === convertISOtoYear(Date.now())) {
        $('#schedule').text(range);
      } else {
        var html = '';
        html += '<div>';
        html += $('<span/>', { class: 'visible-xs' })
          .text(' ' + key + ': ' + range)
          .prop('outerHTML');
        html += $('<span/>', { class: 'hidden-xs' })
          .text('Modelos ' + key + ' o inferiores ' + range)
          .prop('outerHTML');
        html += '</div>';
        $('#schedule-models > div').append(html);
      }
    }
  }
  var abbr = $('<abbr/>', { title: 'Modelos igual o inferiores' })
    .text('≤')
    .prop('outerHTML');
  $('#schedule-models > div span:first-child').prepend(abbr);
}

function loadRestrictions() {
  if (restrictions && restrictions.level) {
    switch (restrictions.level) {
      case 2:
        level = 'warning';
        hash = '#AlertaNaranja';
        free = 'Aplican';
        break;
      case 3:
        level = 'danger';
        hash = '#AlertaRoja';
        free = 'No Aplican';
        break;
      default:
        level = 'info';
        break;
    }

    types.map((type) => weekDays.map((day) => weekRestriction(type, day)));

    if (restrictions.level > 1) {
      setLevel();
      setBike();
      setDates();
    }
    setHours();
  }
}

if (self === top) {
    var antiClickjack = document.getElementById("antiClickjack");
    antiClickjack.parentNode.removeChild(antiClickjack);
} else {
    top.location = self.location;
}

if (window.matchMedia('(display-mode: standalone)').matches) {
    $('a').not('page-scroll').on('click', function () {
        $(this).attr("target", "_blank");
    });
}
$('a[href*="top"]').click(function() {
  registerTag('Menu', 'click', 'Top');
});

$('a[href*="pyp"]').click(function() {
  registerTag('Menu', 'click', 'Restrictions');
});

$('a[href*="map"]').click(function() {
  registerTag('Menu', 'click', 'Mapa');
});

$('a[href*="gps"]').click(function() {
  registerTag('Menu', 'click', 'GPS');
});

$('a[href*="news"]').click(function() {
  registerTag('Menu', 'click', 'News');
});

$('#fbk_btn').click(function() {
  registerTag('Social', 'click', 'Facebook');
});

$('#twt_btn').click(function() {
  registerTag('Social', 'click', 'Twitter');
});

$('#ytb_btn').click(function() {
  registerTag('Social', 'click', 'YouTube');
});

$('#gpsigo').click(function() {
  registerTag('GPS', 'click', 'iGO');
});

$('#gpsgrm').click(function() {
  registerTag('GPS', 'click', 'Garmin');
});
